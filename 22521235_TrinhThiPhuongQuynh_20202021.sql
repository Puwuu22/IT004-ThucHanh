--Cài đặt lược đồ CSDL trên, khai báo khóa chính, khóa ngoại--
CREATE TABLE NHANVIEN(
	MANV VARCHAR(3) CONSTRAINT NV_MANV_PK PRIMARY KEY,
	HOTEN VARCHAR(40) CONSTRAINT NV_HOTEN_NN NOT NULL,
	NGSINH SMALLDATETIME,
	PHAI VARCHAR(3),
	DIACHI VARCHAR(50),
	MAPHG VARCHAR(2),
	LUONG MONEY
)

CREATE TABLE PHONGBAN(
	MAPHG VARCHAR(2) CONSTRAINT PB_MAPHG_PK PRIMARY KEY,
	TENPHG VARCHAR(50),
	TRPHG VARCHAR(3),
	NGNC SMALLDATETIME
)

CREATE TABLE DEAN(
	MADA VARCHAR(5) CONSTRAINT DA_MADA_PK PRIMARY KEY,
	TENDA VARCHAR(50) CONSTRAINT DA_TENDA_NN NOT NULL,
	DDIEM_DA VARCHAR(50),
	MAPHG VARCHAR(2),
	NGBD_DK SMALLDATETIME,
	NGKT_DK SMALLDATETIME
)
 
CREATE TABLE PHANCONG(
	MANV VARCHAR(3),
	MADA VARCHAR(5),
	THOIGIAN INT,
	CONSTRAINT PHANCONG_MANV_MADA_PK PRIMARY KEY (MANV, MADA)
)


--Tao khoa ngoai
ALTER TABLE NHANVIEN
ADD CONSTRAINT NV_MAPHG_FK FOREIGN KEY(MAPHG) REFERENCES PHONGBAN(MAPHG)

ALTER TABLE PHONGBAN
ADD CONSTRAINT PB_TGPHG_FK FOREIGN KEY(TRPHG) REFERENCES NHANVIEN(MANV)

ALTER TABLE DEAN
ADD CONSTRAINT DA_MAPHG_FK FOREIGN KEY(MAPHG) REFERENCES PHONGBAN(MAPHG)

ALTER TABLE PHANCONG
ADD CONSTRAINT PHANCONG_MANV_FK FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE PHANCONG 
ADD CONSTRAINT PHANCONG_MADA_FK FOREIGN KEY(MADA) REFERENCES DEAN(MADA)

--Nhập dữ liệu cho các quan hệ trên.
SET DATEFORMAT DMY 

-- Nhập dữ liệu cho bảng NHANVIEN
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('001', 'Vuong Ngoc Quyen', '22/10/1977', 'Nu', '450 Trung Vuong, HaNoi', 'QL', 30000000)
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('002', 'Nguyen Thanh Tu', '09/01/1975', 'Nam', '731 Tran Hung Dao, Q1, TpHCM', 'NC', 25000000)
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('003', 'Le Thi Nhan', '18/12/1980', 'Nu', '291 Ho Van Hue, QPN, TpHCM', 'DH', 25000000)
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('004', 'Dinh Ba Tien', '09/01/1988', 'Nam', '638 Nguyen Van Cu, Q5, TpHCM', 'NC', 22000000)
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('005', 'Bui Thuy Vu', '19/07/1992', 'Nam', '332 Nguyen Thai Hoc, Q1, TpHCM', 'DH', 23000000)

-- Nhập dữ liệu cho bảng PHONGBAN
INSERT INTO PHONGBAN (MAPHG, TENPHG, TRPHG, NGNC) VALUES ('QL', 'Quan Ly', '001', '22/05/2018')
INSERT INTO PHONGBAN (MAPHG, TENPHG, TRPHG, NGNC) VALUES ('DH', 'Dieu Hanh', '003', '10/10/2020')
INSERT INTO PHONGBAN (MAPHG, TENPHG, TRPHG, NGNC) VALUES ('NC', 'Nghien Cuu', '002', '15/03/2020')

-- Nhập dữ liệu cho bảng DEAN
INSERT INTO DEAN (MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('TH001', 'Tin hoc hoa 1', 'HANOI', 'NC', '01/02/2018', '01/02/2019')
INSERT INTO DEAN (MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('TH002', 'Tin hoc hoa 2', 'TPHCM', 'NC', '04/06/2018', '01/02/2019')
INSERT INTO DEAN (MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('DT001', 'Dao tao 1', 'NHATRANG', 'DH', '01/02/2017', '01/02/2021')
INSERT INTO DEAN (MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('DT002', 'Dao tao 2', 'HANOI', 'DH', '01/02/2017', '01/02/2021')

-- Nhập dữ liệu cho bảng PHANCONG
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('001', 'TH001', 30)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('001', 'TH002', 12)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('002', 'TH001', 10)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('002', 'TH002', 10)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('002', 'DT001', 10)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('002', 'DT002', 10)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('003', 'TH001', 37)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('004', 'DT001', 22)
INSERT INTO PHANCONG (MANV, MADA, THOIGIAN) VALUES ('004', 'DT002', 10)


--Câu 3. Thực hiện các truy vấn--
--a.Cho biết tên phòng ban (TENPHG) có mức lương trung bình từ 24.000.000 trở lên, sắp xếp theo tên phòng ban giảm dần. (1.0 điểm)
SELECT TENPHG, AVG(LUONG) AS LUONG_TRUNGBINH
FROM PHONGBAN, NHANVIEN
WHERE NHANVIEN.MAPHG = PHONGBAN.MAPHG
GROUP BY TENPHG
HAVING AVG(LUONG)>=24000000
ORDER BY TENPHG DESC

--b. Liệt kê thông tin nhân viên (HOTEN) tham gia đề án của phòng “Nghien Cuu” có địa điểm thực hiện đề án tại “HANOI”. (1.0 điểm)
SELECT HOTEN
FROM NHANVIEN NV, PHONGBAN PB, PHANCONG PC, DEAN DA
WHERE PC.MANV = NV.MANV
	AND PC.MADA = DA.MADA
	AND DA.MAPHG = PB.MAPHG
	AND PB.TENPHG = 'NGHIEN CUU'
	AND DA.DDIEM_DA = 'HANOI'

--c. Liệt kê tên nhân viên (HOTEN) và số đề án mà nhân viên đó tham gia. (1.0 điểm)
SELECT NHANVIEN.HOTEN, COUNT(PHANCONG.MADA) AS SOLUONGDEAN
FROM PHANCONG, NHANVIEN
WHERE PHANCONG.MANV = NHANVIEN.MANV
GROUP BY NHANVIEN.HOTEN

--d. Tìm nhân viên (HOTEN) chỉ tham gia những đề án do phòng “Nghien Cuu” chủ trì. (1.0 điểm)
SELECT HOTEN
FROM NHANVIEN NV, PHANCONG PC
WHERE NV.MANV = PC.MANV
EXCEPT
SELECT HOTEN
FROM NHANVIEN NV, PHANCONG PC, DEAN DA, PHONGBAN PB
WHERE NV.MANV = PC.MANV
	AND PC.MADA = DA.MADA
	AND DA.MAPHG = PB.MAPHG
	AND PB.TENPHG != 'NGHIEN CUU'

--e. Tìm họ tên (HOTEN) của các nhân viên làm việc cho tất cả đề án do phòng “Dieu Hanh” chủ trì. (1.0 điểm)
	--tim cac nhan vien ma KHONG co de an nao cua ban DIEUHANH ma KHONG tham gia
SELECT HOTEN 
FROM NHANVIEN 
WHERE NOT EXISTS (
		SELECT*
		FROM DEAN, PHONGBAN
		WHERE DEAN.MAPHG = PHONGBAN.MAPHG
			AND PHONGBAN.TENPHG = 'Dieu Hanh'
			AND NOT EXISTS (
				SELECT*
				FROM PHANCONG
				WHERE DEAN.MADA = PHANCONG.MADA
					AND PHANCONG.MANV = NHANVIEN.MANV
			)
		)

--f. Cho biết tên phòng ban cùng họ tên trưởng phòng của phòng ban có đông nhân viên nhất. 
SELECT TENPHG, HOTEN
FROM NHANVIEN, PHONGBAN
WHERE PHONGBAN.TRPHG = NHANVIEN.MANV
	AND NHANVIEN.MAPHG IN ( 
		SELECT TOP 1 WITH TIES MAPHG
		FROM NHANVIEN
		GROUP BY MAPHG
		ORDER BY COUNT(MANV) DESC
	)
